<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ (‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π - ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∂‡ßÄ‡¶≤ ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£)</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-main: #F4F7F6; --bg-card: #FFFFFF; --primary-green: #005B41;
            --secondary-green: #008170; --accent-gold: #B8860B; --text-dark: #232D3F;
            --text-light: #F4F7F6; --border-color: #DDE2E1; --shadow-soft: 0 4px 12px rgba(0,0,0,0.07);
            --shadow-medium: 0 6px 20px rgba(0,0,0,0.1); --font-bengali: 'Hind Siliguri', sans-serif;
            --radius-main: 12px; --transition-main: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-bengali); background-color: var(--bg-main); color: var(--text-dark); display: flex; justify-content: center; padding: 20px; min-height: 100vh; }
        .website-wrapper { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 15px; }
        .header-section, .time-date-section, .main-option-card, .page-view, .footer-section { border-radius: var(--radius-main); box-shadow: var(--shadow-soft); }
        .header-section { background: linear-gradient(135deg, var(--primary-green), var(--secondary-green)); color: var(--text-light); text-align: center; padding: 12px; }
        .time-date-section { background-color: #e8f3f1; text-align: center; padding: 10px; font-weight: 600; color: var(--primary-green); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; letter-spacing: 0.5px; }
        
        /* Main Menu Grid Layout (2x4) */
        .main-menu-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        @media (max-width: 600px) {
            .main-menu-container {
                grid-template-columns: 1fr;
            }
        }

        .main-option-card { background-color: var(--bg-card); padding: 25px; text-align: center; cursor: pointer; transition: var(--transition-main); border-bottom: 4px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .main-option-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-medium); border-bottom-color: var(--primary-green); }
        .main-option-card .menu-icon { font-size: 2.5em; color: var(--secondary-green); margin-bottom: 15px; font-weight: bold; }
        .main-option-card h2 { font-size: 1.2em; color: var(--primary-green); font-weight: 600; }
        
        .page-view { display: none; background-color: var(--bg-card); padding: 25px; }
        .view-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        .btn-back { background-color: var(--accent-gold); color: white; padding: 8px 16px; border: none; font-size: 0.95em; font-weight: 600; cursor: pointer; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: var(--font-bengali); }
        .btn { background-color: var(--secondary-green); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; transition: var(--transition-main); margin-right: 10px; }
        .btn:hover { background-color: var(--primary-green); transform: translateY(-2px); }
        .btn-danger { background-color: #dc3545; } .btn-warning { background-color: #ffc107; color: #212529; } .btn-info { background-color: #007bff; } .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
        th { background-color: #e8f3f1; color: var(--primary-green); } tfoot td { font-weight: bold; background-color: #e0ebe9; }
        .footer-section { background-color: var(--primary-green); color: #e0e0e0; text-align: center; padding: 15px; font-size: 0.9em; margin-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: var(--radius-main); width: 90%; max-width: 600px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .report-pdf-buttons { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        
        .data-management-box {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-main);
            background-color: #f8f9fa;
        }
        .data-management-box h4 {
            color: var(--primary-green);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .data-management-box p {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 20px;
        }
        .data-management-box .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .kromik-search-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }
        .kromik-search-container input {
            margin-bottom: 0;
        }
        .kromik-search-container button {
            height: 48px;
            margin-right: 0;
        }
    </style>
</head>
<body>
    <div class="website-wrapper">
        <header class="header-section"><h1>‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ</h1></header>
        <section class="time-date-section" id="timeDateDisplay">‡¶∏‡¶Æ‡ßü ‡¶ì ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</section>
        
        <main id="mainMenuContainer">
            <div class="main-menu-container">
                <div class="main-option-card" data-action="showView" data-view-id="salaryCollectionView"><div class="menu-icon">‡¶ü</div><h2>‡¶π‡ßÅ‡¶ú‡ßÅ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π</h2></div>
                <div class="main-option-card" data-action="showView" data-view-id="memberManagementView"><div class="menu-icon">üë•</div><h2>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó/‡¶¨‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</h2></div>
                <div class="main-option-card" data-action="showView" data-view-id="unpaidDuesView"><div class="menu-icon">üßæ</div><h2>‡¶Ö‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2></div>
                <div class="main-option-card" data-action="showView" data-view-id="whatsappView"><div class="menu-icon">üì±</div><h2>‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2></div>
                <div class="main-option-card" data-action="showView" data-view-id="backupRestoreView"><div class="menu-icon">üíæ</div><h2>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™/‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h2></div>
                <div class="main-option-card" data-action="showView" data-view-id="allDataPdfView"><div class="menu-icon">üìÑ</div><h2>‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø PDF</h2></div>
                <div class="main-option-card" data-action="showView" data-view-id="dashboardView"><div class="menu-icon">üìä</div><h2>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h2></div>
            </div>
        </main>
        
        <section id="salaryCollectionView" class="page-view">
            <div class="view-header"><h2>‡¶π‡ßÅ‡¶ú‡ßÅ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div>
            <form id="salaryCollectionForm">
                <!-- Kromik Number Search -->
                <div class="kromik-search-container">
                    <div>
                        <label for="kromikNumberInput">‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®:</label>
                        <input type="number" id="kromikNumberInput" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßá Enter ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®">
                    </div>
                    <button type="button" class="btn" data-action="findMemberByKromik">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                </div>
                
                <label for="salaryCollectorSelect">‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select id="salaryCollectorSelect" required></select>

                <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;"><input type="month" id="salaryMonthSelector" style="flex-grow: 1;"><button type="button" class="btn btn-sm btn-info" data-action="addMonthToSalarySelection">‡¶Æ‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
                <div id="salarySelectedMonthsContainer" style="margin-bottom: 15px;"></div><label for="salaryCollectionDate">‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="salaryCollectionDate" required>
                <button type="submit" class="btn">‡¶¨‡ßá‡¶§‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
            </form>
            <hr style="margin: 30px 0;"><h3>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h3>
            <div class="report-controls" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                <button class="btn btn-info" data-action="generateSalaryReport" data-period="daily">‡¶¶‡ßà‡¶®‡¶ø‡¶ï</button><button class="btn btn-info" data-action="generateSalaryReport" data-period="weekly">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï</button>
                <button class="btn btn-info" data-action="generateSalaryReport" data-period="monthly">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï</button><button class="btn btn-info" data-action="generateSalaryReport" data-period="yearly">‡¶¨‡¶æ‡ßé‡¶∏‡¶∞‡¶ø‡¶ï</button>
            </div><div id="salaryReportOutput"></div>
        </section>
        
        <section id="memberManagementView" class="page-view">
            <div class="view-header"><h2>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div>
            
            <div class="data-management-box">
                <h4>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h4>
                <p>‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ PDF ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶Æ‡¶¶‡¶æ‡¶®‡¶ø/‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§</p>
                <div class="button-group">
                    <button class="btn btn-sm btn-info" data-action="exportMembersToPDF">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ PDF</button>
                </div>
                <div class="button-group report-pdf-buttons">
                    <button class="btn btn-sm" data-action="exportMembersToJSON">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø (JSON)</button>
                    <button class="btn btn-sm" data-action="triggerMemberImport">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ü‡¶Æ‡¶¶‡¶æ‡¶®‡¶ø (JSON)</button>
                    <input type="file" id="memberImportFile" style="display: none;" accept=".json">
                </div>
            </div>

            <form id="memberForm"><label for="banglaNameInput">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶®‡¶æ‡¶Æ:</label><input type="text" id="banglaNameInput" required><label for="englishNameInput">‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶®‡¶æ‡¶Æ:</label><input type="text" id="englishNameInput" required>
            <label for="mobileNumberInput">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡ßß‡ßß ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ):</label><input type="tel" id="mobileNumberInput" pattern="[0-9]{11}"><label for="monthlyFeeInput">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶® (‡¶ü‡¶æ‡¶ï‡¶æ):</label><input type="number" id="monthlyFeeInput" required>
            <input type="hidden" id="editingMemberId"><button type="submit" class="btn">‡¶Ø‡ßã‡¶ó/‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button></form><h3 style="margin-top: 30px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶ó‡¶£</h3>
            <div id="memberListContainer" style="margin-top: 20px;"></div>
        </section>
        
        <section id="unpaidDuesView" class="page-view">
             <div class="view-header"><h2>‡¶Ö‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;"><div><label for="unpaidCheckStartMonth">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶Æ‡¶æ‡¶∏:</label><input type="month" id="unpaidCheckStartMonth"></div><div><label for="unpaidCheckEndMonth">‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∏:</label><input type="month" id="unpaidCheckEndMonth"></div></div>
            <button class="btn" data-action="generateUnpaidReport">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button><div id="unpaidReportOutput" style="margin-top: 20px;"></div>
        </section>
        
        <section id="whatsappView" class="page-view">
            <div class="view-header"><h2>‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div><p style="font-size:0.9em; color:#555; margin-bottom:20px;">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡ßá‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
            <form id="whatsappForm"><div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"><div><label for="whatsappContactName">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶™‡¶¶‡¶¨‡ßÄ:</label><input type="text" id="whatsappContactName" required></div><div><label for="whatsappContactNumber">‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶¶‡ßá‡¶∂ ‡¶ï‡ßã‡¶° ‡¶∏‡¶π):</label><input type="tel" id="whatsappContactNumber" required placeholder="8801..."></div></div>
            <button type="submit" class="btn">‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button></form><h3 style="margin-top: 30px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
            <div id="whatsappListContainer" style="margin-top: 20px;"></div>
        </section>
        
        <section id="backupRestoreView" class="page-view">
            <div class="view-header"><h2>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ì ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div><h4>‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</h4><p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø (‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø, ‡¶¨‡ßá‡¶§‡¶®) ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶è‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <button class="btn" data-action="backupAllData">‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® (JSON)</button><hr style="margin: 30px 0;"><h4>‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h4>
            <p>‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡ßü, ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ <strong>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:</strong> ‡¶è‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡•§</p>
            <input type="file" id="restoreFileInput" accept=".json"><button class="btn" data-action="handleRestoreData">‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </section>

        <section id="allDataPdfView" class="page-view">
            <div class="view-header"><h2>‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø PDF ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div>
            <p>‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ PDF ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶Ø‡¶º ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶Ø‡ßá ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá, ‡¶∏‡ßá‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶§‡ßá‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§</p>
            <div class="report-controls" style="display: flex; justify-content: center; margin: 20px 0;">
                 <button class="btn btn-info" data-action="generateAllMonthsPdf" style="font-size: 1.1em; padding: 15px 25px;">
                    ‡¶∏‡¶ï‡¶≤ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </section>
        
        <section id="dashboardView" class="page-view">
            <div class="view-header"><h2>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h2><button class="btn-back" data-action="showView" data-view-id="mainMenuContainer">‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button></div>
            <div id="dashboardContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
            </div>
        </section>

        <div id="modalContainer"></div>
        
        <footer class="footer-section">
            <p>&copy; <span id="currentYear"></span> ‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶π‡¶æ‡¶≤‡¶ø‡¶Æ ‡¶∏‡¶æ‡¶Ø‡¶º‡ßá‡¶Æ‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡¶∏‡ßç‡¶¨‡¶§‡ßç‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§</p>
        </footer>
    </div>

<script>
// --- APPLICATION START ---
const { jsPDF } = window.jspdf;

document.addEventListener('DOMContentLoaded', () => {

    const app = {
        // --- DATA KEYS & STORAGE ---
        KEYS: { members: 'hujurSalary_members_v15', collections: 'hujurSalary_collections_v15', whatsappContacts: 'hujurSalary_whatsappContacts_v15' },
        members: [], collections: [], whatsappContacts: [],
        nextKromikNo: 1, selectedMonthsForSalary: [],
        
        HIND_SILIGURI_FONT: 'AAEAAAARAQAABAAQR0RFRgQsBBsAACAoAAAAHkdTVUKs05usAAAG9AAAAExPUy8yIVv/lQAAAUgAAACgY21hcBIAA0cAAAjwAAABUmdhc3D//wADAAh4AAAAIGdseWZP79s/AAALTAAAeixoZWFkCT8VugAAAngAAAA2aGhlYQclA/sAAAKEAAAAJGhtdHgM8wKkAAACjAAAA3Bsb2Nh0FrZTQAAgxwAAAEqbWF4cAIkAjgAAAGQAAAAIG5hbWUeOBWeAAChRAAAAsZwb3N0/5wAMgAAwvAAAABacHJlcGgGjIUDAAABOAAAABJ3ZWJm1yS2vQAAx+wAAAAGAAAAAQAAAADMPaLPAAAAAM9Vza0AAAADPosjmwAAAAAAARIAAAAAAAGAAAAAAAAAoAAAAFAAAAAAANAM0AAQAAAAAAAgAAAAoACgAAAP8ABAABAAD//wAAAP8AAAAAAQAAAAoACgAAAAAEAAIAAAAAAAAAAQAAAAAAVQJSAQAAAAAFAGkC1wAAAAAAAQAAAAAAAQABAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAAQAAAAEAAAAAA-A-L-L--T-H-E--R-E-A-L--B-A-S-E-6-4--F-O-N-T--D-A-T-A--G-O-E-S--H-E-R-E---', 

        // --- INITIALIZATION ---
        init() {
            this.loadData();
            document.querySelector('.website-wrapper').addEventListener('click', this.handleDelegatedClick.bind(this));
            document.querySelector('.website-wrapper').addEventListener('submit', this.handleFormSubmit.bind(this));
            document.getElementById('kromikNumberInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.findMemberByKromik();
                }
            });
            this.updateTime();
            setInterval(() => this.updateTime(), 1000);
            document.getElementById('currentYear').textContent = new Date().getFullYear().toLocaleString('bn-BD');
            this.showView({ viewId: 'mainMenuContainer' });
        },
        loadData() {
            try {
                this.members = JSON.parse(localStorage.getItem(this.KEYS.members) || '[]');
                this.collections = JSON.parse(localStorage.getItem(this.KEYS.collections) || '[]');
                this.whatsappContacts = JSON.parse(localStorage.getItem(this.KEYS.whatsappContacts) || '[]');
                this.nextKromikNo = this.members.length > 0 ? Math.max(...this.members.map(m => m.kromikNo || 0)) + 1 : 1;
            } catch (e) { console.error("Error loading data:", e); }
        },
        saveData() {
            localStorage.setItem(this.KEYS.members, JSON.stringify(this.members));
            localStorage.setItem(this.KEYS.collections, JSON.stringify(this.collections));
            localStorage.setItem(this.KEYS.whatsappContacts, JSON.stringify(this.whatsappContacts));
        },
        
        // --- EVENT HANDLING ---
        handleDelegatedClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            if (this[action]) this[action](target.dataset);
        },
        handleFormSubmit(e) {
            e.preventDefault();
            const formActions = {
                memberForm: 'handleMemberSubmit',
                salaryCollectionForm: 'handleSalarySubmit',
                whatsappForm: 'handleWhatsAppSubmit'
            };
            const action = formActions[e.target.id];
            if (action && this[action]) this[action]();
        },
        
        // --- VIEW MANAGEMENT ---
        showView({ viewId }) {
            document.querySelectorAll('.page-view, #mainMenuContainer').forEach(v => v.style.display = 'none');
            const viewElement = document.getElementById(viewId);
            if(viewElement) {
                viewElement.style.display = viewId === 'mainMenuContainer' ? 'block' : 'block';
                this.initializeView(viewId);
            }
        },
        initializeView(viewId) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            switch (viewId) {
                case 'salaryCollectionView': this.initSalaryCollection(); break;
                case 'memberManagementView': this.renderMemberList(); break;
                case 'unpaidDuesView':
                    document.getElementById('unpaidCheckStartMonth').value = `${year}-01`;
                    document.getElementById('unpaidCheckEndMonth').value = `${year}-${month}`;
                    break;
                case 'whatsappView': this.renderWhatsappList(); break;
                case 'dashboardView': this.renderDashboard(); break;
            }
        },
        
        // --- UTILITY & FORMATTING FUNCTIONS ---
        updateTime() { 
            const now = new Date(); 
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }; 
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; 
            document.getElementById('timeDateDisplay').textContent = `${now.toLocaleDateString('bn-BD', dateOptions)}, ${now.toLocaleTimeString('en-US', timeOptions)}`; 
        },
        formatBn(val, type) { if (!val) return ''; const date = new Date(val + (type === 'month' ? '-02T00:00:00' : 'T12:00:00')); const options = type === 'month' ? { month: 'long', year: 'numeric' } : { day: 'numeric', month: 'long', year: 'numeric' }; return date.toLocaleDateString('bn-BD', options); },
        formatDateBn(dateStr) { return this.formatBn(dateStr, 'date'); },
        formatMonthBn(monthStr) { return this.formatBn(monthStr, 'month'); },
        formatEn(val, type) { if (!val) return ''; const date = new Date(val + (type === 'month' ? '-02T00:00:00' : 'T12:00:00')); const options = type === 'month' ? { month: 'long', year: 'numeric' } : { day: '2-digit', month: 'short', year: 'numeric' }; return date.toLocaleDateString('en-US', options); },
        formatDateEn(dateStr) { return this.formatEn(dateStr, 'date'); },
        formatMonthEn(monthStr) { return this.formatEn(monthStr, 'month'); },
        
        getReportData(type, data, dateField) { let reportData = [], title = '', pdfTitle = ''; const now = new Date(); const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay()); startOfWeek.setHours(0,0,0,0); const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); endOfWeek.setHours(23,59,59,999); switch (type) { case 'daily': const todayStr = now.toISOString().split('T')[0]; reportData = data.filter(c => c[dateField].slice(0, 10) === todayStr); title = `‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (${this.formatDateBn(todayStr)})`; pdfTitle = `Daily Report - ${this.formatDateEn(todayStr)}`; break; case 'weekly': reportData = data.filter(c => new Date(c[dateField]) >= startOfWeek && new Date(c[dateField]) <= endOfWeek); title = `‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (${this.formatDateBn(startOfWeek)} - ${this.formatDateBn(endOfWeek)})`; pdfTitle = `Weekly Report (${this.formatDateEn(startOfWeek)} to ${this.formatDateEn(endOfWeek)})`; break; case 'monthly': const currentMonth = now.toISOString().slice(0, 7); reportData = data.filter(c => c[dateField].slice(0, 7) === currentMonth); title = `‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (${this.formatMonthBn(currentMonth)})`; pdfTitle = `Monthly Report - ${this.formatMonthEn(currentMonth)}`; break; case 'yearly': const currentYear = now.getFullYear(); reportData = data.filter(c => new Date(c[dateField]).getFullYear() === currentYear); title = `‡¶¨‡¶æ‡ßé‡¶∏‡¶∞‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (${currentYear.toLocaleString('bn-BD')})`; pdfTitle = `Yearly Report - ${currentYear}`; break; } return { reportData, title, pdfTitle }; },
        
        // --- MEMBER MANAGEMENT ---
        handleMemberSubmit() { const banglaName = document.getElementById('banglaNameInput').value.trim(); const englishName = document.getElementById('englishNameInput').value.trim(); const mobileNumber = document.getElementById('mobileNumberInput').value.trim(); const monthlyFee = parseFloat(document.getElementById('monthlyFeeInput').value); const editingId = document.getElementById('editingMemberId').value; if (!banglaName || !englishName || isNaN(monthlyFee)) return alert('‡¶∏‡¶ï‡¶≤ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); if (mobileNumber && !/^[0-9]{11}$/.test(mobileNumber)) return alert('‡¶∏‡¶†‡¶ø‡¶ï ‡ßß‡ßß ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®‡•§'); if (this.members.some(m => m.id !== editingId && (m.banglaName === banglaName || (mobileNumber && m.mobileNumber === mobileNumber)))) return alert('‡¶è‡¶á ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶Ü‡¶õ‡ßá‡¶®‡•§'); if (editingId) { const member = this.members.find(m => m.id === editingId); if (member) Object.assign(member, { banglaName, englishName, mobileNumber, monthlyFee }); } else { this.members.push({ id: `m_${Date.now()}`, kromikNo: this.nextKromikNo++, banglaName, englishName, mobileNumber, monthlyFee, isActive: true }); } this.saveData(); this.renderMemberList(); document.getElementById('memberForm').reset(); document.getElementById('editingMemberId').value = ''; alert('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); },
        renderMemberList() { const container = document.getElementById('memberListContainer'); container.innerHTML = ''; this.members.sort((a,b) => (a.kromikNo || 0) - (b.kromikNo || 0)).forEach(member => { const itemDiv = document.createElement('div'); itemDiv.className = 'list-item'; itemDiv.style.cssText = `display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom: 1px solid #eee; opacity: ${member.isActive ? '1' : '0.6'};`; itemDiv.innerHTML = `<div style="flex-grow:1;"><strong>${member.kromikNo}. ${member.banglaName}</strong> (${member.englishName})<br><small>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${member.mobileNumber || 'N/A'} | ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶®: ${member.monthlyFee.toLocaleString('bn-BD')} ‡ß≥</small></div><div class="item-actions" style="flex-shrink:0;"><button class="btn btn-sm btn-warning" data-action="editMember" data-id="${member.id}">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button><button class="btn btn-sm ${member.isActive ? 'btn-danger' : 'btn'}" data-action="toggleMemberStatus" data-id="${member.id}">${member.isActive ? '‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶®' : '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®'}</button></div>`; container.appendChild(itemDiv); }); },
        editMember({id}) { const member = this.members.find(m => m.id === id); if (member) { document.getElementById('banglaNameInput').value = member.banglaName; document.getElementById('englishNameInput').value = member.englishName; document.getElementById('mobileNumberInput').value = member.mobileNumber; document.getElementById('monthlyFeeInput').value = member.monthlyFee; document.getElementById('editingMemberId').value = id; document.getElementById('memberForm').scrollIntoView({ behavior: 'smooth' }); } },
        toggleMemberStatus({id}) { const member = this.members.find(m => m.id === id); if (member && confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${member.banglaName}" ‡¶è‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) { member.isActive = !member.isActive; this.saveData(); this.renderMemberList(); } },
        exportMembersToJSON() { if (this.members.length === 0) return alert('‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§'); const dataStr = JSON.stringify(this.members, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'mosque_members_backup.json'; a.click(); URL.revokeObjectURL(url); },
        triggerMemberImport() { document.getElementById('memberImportFile').click(); document.getElementById('memberImportFile').onchange = (e) => this.handleMemberImport(e); },
        handleMemberImport(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const imported = JSON.parse(e.target.result); if (!Array.isArray(imported)) throw new Error('Invalid format'); if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${imported.length} ‡¶ú‡¶® ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶ï‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶®‡¶æ‡¶Æ/‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶¨‡ßá‡•§`)) { imported.forEach(newMember => { if (!this.members.some(existing => existing.banglaName === newMember.banglaName || (newMember.mobileNumber && existing.mobileNumber === newMember.mobileNumber))) this.members.push(newMember); }); this.saveData(); this.loadData(); this.renderMemberList(); alert('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ü‡¶Æ‡¶¶‡¶æ‡¶®‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); } } catch (err) { alert('‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï JSON ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶®‡ßá‡¶á‡•§'); } }; reader.readAsText(file); event.target.value = ''; },
        
        // --- SALARY COLLECTION ---
        initSalaryCollection() {
            document.getElementById('kromikNumberInput').value = '';
            this.populateSalaryCollectorSelect();
            this.selectedMonthsForSalary = []; 
            this.renderSelectedSalaryMonths(); 
            const now = new Date(); 
            document.getElementById('salaryCollectionDate').valueAsDate = now; 
            document.getElementById('salaryMonthSelector').value = now.toISOString().slice(0, 7); 
        },
        populateSalaryCollectorSelect() { const select = document.getElementById('salaryCollectorSelect'); select.innerHTML = '<option value="">-- ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>'; this.members.filter(m => m.isActive).sort((a,b)=>(a.kromikNo || 0)-(b.kromikNo || 0)).forEach(member => { const option = document.createElement('option'); option.value = member.id; option.textContent = `${member.kromikNo}. ${member.banglaName}`; option.dataset.fee = member.monthlyFee; select.appendChild(option); }); },
        findMemberByKromik() {
            const kromikNo = parseInt(document.getElementById('kromikNumberInput').value);
            if (isNaN(kromikNo)) return;
            const member = this.members.find(m => m.kromikNo === kromikNo && m.isActive);
            if (member) {
                document.getElementById('salaryCollectorSelect').value = member.id;
            } else {
                alert('‡¶è‡¶á ‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                document.getElementById('salaryCollectorSelect').value = '';
            }
            document.getElementById('kromikNumberInput').value = ''; // Clear input after search
        },
        addMonthToSalarySelection() { const monthValue = document.getElementById('salaryMonthSelector').value; const memberId = document.getElementById('salaryCollectorSelect').value; if (!monthValue || !memberId) return alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); const isAlreadyPaid = this.collections.some(c => c.memberId === memberId && c.feeForMonth === monthValue); if (isAlreadyPaid) { const member = this.members.find(m => m.id === memberId); return alert(`${member.banglaName} ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ${this.formatMonthBn(monthValue)} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`); } if (this.selectedMonthsForSalary.some(item => item.month === monthValue)) return alert('‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); const member = this.members.find(m => m.id === memberId); this.selectedMonthsForSalary.push({ month: monthValue, amount: member.monthlyFee, tempId: `m_${Date.now()}` }); this.selectedMonthsForSalary.sort((a, b) => a.month.localeCompare(b.month)); this.renderSelectedSalaryMonths(); },
        renderSelectedSalaryMonths() { const container = document.getElementById('salarySelectedMonthsContainer'); container.innerHTML = ''; this.selectedMonthsForSalary.forEach(item => { const div = document.createElement('div'); div.className = 'selected-month-item'; div.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom: 5px;'; div.innerHTML = `<span style="flex-grow:1;">${this.formatMonthBn(item.month)}:</span><input type="number" class="btn-sm" value="${item.amount}" onchange="app.updateSalaryAmountForMonth({id:'${item.tempId}', value:this.value})"><button type="button" class="btn btn-sm btn-danger" data-action="removeMonthFromSalarySelection" data-id="${item.tempId}">‡¶∏‡¶∞‡¶æ‡¶®</button>`; container.appendChild(div); }); },
        updateSalaryAmountForMonth({id, value}) { const item = this.selectedMonthsForSalary.find(i => i.tempId === id); if (item) item.amount = parseFloat(value) || 0; },
        removeMonthFromSalarySelection({id}) { this.selectedMonthsForSalary = this.selectedMonthsForSalary.filter(i => i.tempId !== id); this.renderSelectedSalaryMonths(); },
        handleSalarySubmit() { const memberId = document.getElementById('salaryCollectorSelect').value; const collectionDate = document.getElementById('salaryCollectionDate').value; if (!memberId || !collectionDate || this.selectedMonthsForSalary.length === 0) return alert('‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø, ‡¶Æ‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); const member = this.members.find(m => m.id === memberId); this.selectedMonthsForSalary.forEach(item => { if (item.amount > 0) this.collections.push({ id: `c_${Date.now()}_${Math.random()}`, memberId, donorBanglaName: member.banglaName, donorEnglishName: member.englishName, amount: item.amount, feeForMonth: item.month, collectionDate }); }); this.saveData(); alert('‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); this.initSalaryCollection(); },
        generateSalaryReport({period}) {
            const outputDiv = document.getElementById('salaryReportOutput');
            const { reportData, title } = this.getReportData(period, this.collections, 'collectionDate');
            outputDiv.innerHTML = `<h3>${title}</h3>`;
            if (reportData.length === 0) {
                outputDiv.innerHTML += '<p>‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
                return;
            }
            let total = reportData.reduce((sum, item) => sum + item.amount, 0);
            const table = document.createElement('table');
            table.innerHTML = `
                <thead><tr><th>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</th><th>‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∏</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</th><th>‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶ï‡¶∞‡ßç‡¶Æ</th></tr></thead>
                <tbody>${reportData.map(item => `
                    <tr>
                        <td>${item.donorBanglaName}</td>
                        <td>${this.formatMonthBn(item.feeForMonth)}</td>
                        <td>${item.amount.toLocaleString('bn-BD')}</td>
                        <td>${this.formatDateBn(item.collectionDate)}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" data-action="editSalaryRecord" data-id="${item.id}" data-period="${period}">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
                            <button class="btn btn-sm btn-danger" data-action="deleteSalaryRecord" data-id="${item.id}" data-period="${period}">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                        </td>
                    </tr>`).join('')}
                </tbody>
                <tfoot><tr><td colspan="2" style="text-align:right;"><b>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü</b></td><td><b>${total.toLocaleString('bn-BD')}</b></td><td colspan="2"></td></tr></tfoot>`;
            outputDiv.appendChild(table);
            const pdfButtons = `<div class="report-pdf-buttons">
                <button class="btn" data-action="generateReportPDF" data-type="salary" data-period="${period}">Download PDF</button>
            </div>`;
            outputDiv.insertAdjacentHTML('beforeend', pdfButtons);
        },
        deleteSalaryRecord({id, period}) {
            const record = this.collections.find(c => c.id === id);
            if(record && confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${record.donorBanglaName}" ‡¶è‡¶∞ "${this.formatMonthBn(record.feeForMonth)}" ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® (${record.amount} ‡ß≥) ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) {
                this.collections = this.collections.filter(c => c.id !== id);
                this.saveData();
                alert("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                this.generateSalaryReport({period});
            }
        },
        editSalaryRecord({id, period}) {
            const record = this.collections.find(c => c.id === id);
            if (!record) return;
            const modalHTML = `
            <div class="modal" id="editSalaryModal" style="display:block;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                        <span class="close-btn" data-action="closeModal">&times;</span>
                    </div>
                    <p><strong>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø:</strong> ${record.donorBanglaName}<br><strong>‡¶Æ‡¶æ‡¶∏:</strong> ${this.formatMonthBn(record.feeForMonth)}</p>
                    <div style="margin-top: 20px;">
                        <label for="editSalaryAmount">‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
                        <input type="number" id="editSalaryAmount" value="${record.amount}">
                        <label for="editSalaryDate">‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                        <input type="date" id="editSalaryDate" value="${record.collectionDate}">
                        <button class="btn" id="saveSalaryEditBtn">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>`;
            document.getElementById('modalContainer').innerHTML = modalHTML;
            document.getElementById('saveSalaryEditBtn').addEventListener('click', () => {
                const newAmount = parseFloat(document.getElementById('editSalaryAmount').value);
                const newDate = document.getElementById('editSalaryDate').value;
                if(isNaN(newAmount) || !newDate) {
                    return alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡¶ø‡¶®‡•§");
                }
                record.amount = newAmount;
                record.collectionDate = newDate;
                this.saveData();
                alert("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                this.closeModal();
                this.generateSalaryReport({period});
            });
        },
        
        // --- UNPAID REPORT ---
        generateUnpaidReport() { const startMonthStr = document.getElementById('unpaidCheckStartMonth').value; const endMonthStr = document.getElementById('unpaidCheckEndMonth').value; const outputDiv = document.getElementById('unpaidReportOutput'); if (!startMonthStr || !endMonthStr) return alert("‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶è‡¶¨‡¶Ç ‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"); outputDiv.innerHTML = `<h3>‡¶Ö‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (${this.formatMonthBn(startMonthStr)} ‡¶•‡ßá‡¶ï‡ßá ${this.formatMonthBn(endMonthStr)})</h3>`; let tableHTML = `<table><thead><tr><th>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</th><th>‡¶Ö‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶∏</th><th>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)</th><th>‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®</th></tr></thead><tbody>`; let hasUnpaid = false; this.members.filter(m => m.isActive).forEach(member => { let unpaidMonths = [], totalDue = 0; let current = new Date(startMonthStr + '-01'); const end = new Date(endMonthStr + '-01'); while(current <= end) { const monthToCheck = current.toISOString().slice(0, 7); if (!this.collections.some(c => c.memberId === member.id && c.feeForMonth === monthToCheck)) { unpaidMonths.push(monthToCheck); totalDue += member.monthlyFee; } current.setMonth(current.getMonth() + 1); } if (unpaidMonths.length > 0) { hasUnpaid = true; const lastPaid = this.collections.filter(c => c.memberId === member.id).sort((a,b) => new Date(b.collectionDate) - new Date(a.collectionDate))[0]; const lastPaidDate = lastPaid ? this.formatDateBn(lastPaid.collectionDate) : '‡¶ï‡¶ñ‡¶®‡ßã ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶π‡ßü‡¶®‡¶ø'; const unpaidMonthsBn = unpaidMonths.map(m => this.formatMonthBn(m).split(' ')[0]).join(', '); const smsText = `‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶ó‡¶§‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶æ‡¶®‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶Ø‡ßá, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ó‡¶§ ${unpaidMonthsBn} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ${totalDue.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡ßá‡¶§‡¶® ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßá‡¶® ‡¶®‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶õ‡¶ø‡¶≤ ${lastPaidDate}‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßá‡¶§‡¶® ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ -‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï: ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶ï‡¶Æ‡¶ø‡¶ü‡¶ø‡•§`; tableHTML += `<tr><td>${member.banglaName}<br><small>${member.mobileNumber || ''}</small></td><td>${unpaidMonthsBn}</td><td>${totalDue.toLocaleString('bn-BD')}</td><td><a href="sms:${member.mobileNumber}?body=${encodeURIComponent(smsText)}" class="btn btn-sm">SMS</a></td></tr>`; } }); if (!hasUnpaid) tableHTML += `<tr><td colspan="4" style="text-align:center;">‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§</td></tr>`; tableHTML += `</tbody></table>`; outputDiv.innerHTML += tableHTML; },
        
        // --- WHATSAPP & MODALS ---
        handleWhatsAppSubmit() { const name = document.getElementById('whatsappContactName').value.trim(); const number = document.getElementById('whatsappContactNumber').value.trim(); if(name && number) { this.whatsappContacts.push({id:`w_${Date.now()}`, name, number}); this.saveData(); this.renderWhatsappList(); document.getElementById('whatsappForm').reset(); } },
        renderWhatsappList() { const container = document.getElementById('whatsappListContainer'); container.innerHTML = ''; this.whatsappContacts.forEach(c => { const div = document.createElement('div'); div.className = 'list-item'; div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom: 1px solid #eee;'; div.innerHTML = `<div><strong>${c.name}</strong><br><small>${c.number}</small></div><div class="item-actions" style="flex-shrink:0;"><button class="btn btn-sm" data-action="openWhatsappModal" data-id="${c.id}">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button><button class="btn btn-sm btn-danger" data-action="removeWhatsappContact" data-id="${c.id}">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button></div>`; container.appendChild(div); }); },
        removeWhatsappContact({id}) { this.whatsappContacts = this.whatsappContacts.filter(c => c.id !== id); this.saveData(); this.renderWhatsappList(); },
        openWhatsappModal({id}) { const modalHTML = `<div class="modal" id="whatsappReportModal" style="display:block;"><div class="modal-content"><div class="modal-header"><h3>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3><span class="close-btn" data-action="closeModal">&times;</span></div><div class="modal-body"><div class="report-option-group" style="margin-top:15px;"><h4>‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</h4><button class="btn btn-sm" data-action="sendWhatsappReport" data-id="${id}" data-period="daily" data-format="text">‡¶¶‡ßà‡¶®‡¶ø‡¶ï</button><button class="btn btn-sm" data-action="sendWhatsappReport" data-id="${id}" data-period="weekly" data-format="text">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï</button><button class="btn btn-sm" data-action="sendWhatsappReport" data-id="${id}" data-period="monthly" data-format="text">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï</button><button class="btn btn-sm" data-action="sendWhatsappReport" data-id="${id}" data-period="yearly" data-format="text">‡¶¨‡¶æ‡ßé‡¶∏‡¶∞‡¶ø‡¶ï</button></div></div></div></div>`; document.getElementById('modalContainer').innerHTML = modalHTML; },
        closeModal() { document.getElementById('modalContainer').innerHTML = ''; },
        sendWhatsappReport({id, period, format}) { 
            const contact = this.whatsappContacts.find(c => c.id === id); 
            if(!contact) return; 
            const salaryReport = this.getReportData(period, this.collections, 'collectionDate'); 
            const totalSalary = salaryReport.reportData.reduce((s,i)=>s+i.amount,0); 
            let text = `*${salaryReport.title}*\n\n*‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π:*\n-----------------------\n`; 
            if(salaryReport.reportData.length > 0) {
                salaryReport.reportData.forEach(item => { 
                    text += `${item.donorBanglaName} (${this.formatMonthBn(item.feeForMonth)}) - ${item.amount.toLocaleString('bn-BD')} ‡ß≥\n`; 
                }); 
            } else {
                text += '‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§\n'; 
            }
            text += `\n*‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü: ${totalSalary.toLocaleString('bn-BD')} ‡ß≥*`; 
            window.open(`https://wa.me/${contact.number}?text=${encodeURIComponent(text)}`, '_blank'); 
            this.closeModal(); 
        },
        
        // --- PDF GENERATION ---
        exportMembersToPDF() {
            if (this.members.length === 0) return alert('PDF ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§');
            const doc = new jsPDF();
            doc.setFont('helvetica');
            const title = "Member List";
            const headers = [['#', 'Name (English)', 'Mobile', 'Fee (Tk)']];
            const body = this.members.filter(m => m.isActive).sort((a,b) => (a.kromikNo || 0) - (b.kromikNo || 0)).map(m => [m.kromikNo, m.englishName, m.mobileNumber || 'N/A', m.monthlyFee.toString()]);
            const filename = 'member_list_en.pdf';
            doc.text(title, 14, 15);
            doc.autoTable({ head: headers, body, startY: 20 });
            doc.save(filename);
        },
        generateReportPDF({type, period}) {
            const doc = new jsPDF();
            doc.setFont('helvetica');
            let title, filename, headers, body, foot;
            
            if (type === 'salary') {
                const { reportData, pdfTitle: enTitle } = this.getReportData(period, this.collections, 'collectionDate');
                if (reportData.length === 0) return alert('‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§');
                let total = reportData.reduce((s, i) => s + i.amount, 0);
                
                title = enTitle;
                headers = [['Member (English)', 'Fee For Month', 'Amount (Tk)', 'Collection Date']];
                body = reportData.map(item => [item.donorEnglishName, this.formatMonthEn(item.feeForMonth), item.amount.toFixed(2), this.formatDateEn(item.collectionDate)]);
                foot = [['Total', '', total.toFixed(2), '']];
                filename = `salary_report_${period}_en.pdf`;
            }

            doc.text(title, 14, 15);
            doc.autoTable({ head: headers, body, foot, startY: 20 });
            doc.save(filename);
        },

        // --- DASHBOARD VIEW (REVISED) ---
        renderDashboard() {
            const dashboardContent = document.getElementById('dashboardContent');
            dashboardContent.innerHTML = '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

            const activeMembers = this.members.filter(m => m.isActive).length;
            let contentHTML = `
                <div style="background-color: #e8f3f1; padding: 20px; border-radius: 10px; text-align: center; grid-column: 1 / -1;">
                    <h3 style="color: var(--primary-green);">‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</h3>
                    <p style="font-size: 2.5em; font-weight: bold; color: var(--secondary-green);">${activeMembers.toLocaleString('bn-BD')}</p>
                </div>
            `;
            
            // Get all unique years from collections data and sort them descending
            const allYears = [...new Set(this.collections.map(c => c.collectionDate.slice(0, 4)))].sort((a, b) => b.localeCompare(a));
            const currentYearStr = new Date().getFullYear().toString();

            // Ensure the current year is in the list, even if there's no data yet.
            if (!allYears.includes(currentYearStr)) {
                allYears.unshift(currentYearStr);
            }

            allYears.forEach(year => {
                contentHTML += `<h3 style="grid-column: 1 / -1; text-align: center; background: var(--primary-green); color: white; padding: 10px; border-radius: 8px; margin-top: 20px; margin-bottom: 0;">${parseInt(year).toLocaleString('bn-BD')} ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h3>`;

                // Loop through all 12 months for the given year
                for (let i = 0; i < 12; i++) { // 0 for Jan, 11 for Dec
                    const monthDate = new Date(year, i, 1);
                    const monthStr = monthDate.toISOString().slice(0, 7);
                    const monthTitle = this.formatMonthBn(monthStr);

                    // 1. "‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶´‡¶ø": Fee collected *FOR* this specific month (e.g., all January fees, paid anytime)
                    const feeForMonthTotal = this.collections
                        .filter(c => c.feeForMonth.slice(0, 7) === monthStr)
                        .reduce((sum, item) => sum + item.amount, 0);

                    // 2. "‡¶ê ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡ßü": Total fee collected *IN* this specific month (cash flow)
                    const collectedInMonthTotal = this.collections
                        .filter(c => c.collectionDate.slice(0, 7) === monthStr)
                        .reduce((sum, item) => sum + item.amount, 0);

                    // Build the HTML block for the month
                    contentHTML += `
                        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid var(--accent-gold);">
                            <h4 style="color: var(--primary-green); border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 12px;">${monthTitle}</h4>
                            <p style="margin-bottom: 5px;">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶´‡¶ø: <strong>${feeForMonthTotal.toLocaleString('bn-BD')} ‡ß≥</strong></p>
                            <p>‡¶ê ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡ßü: <strong>${collectedInMonthTotal.toLocaleString('bn-BD')} ‡ß≥</strong></p>
                        </div>
                    `;
                }
            });

            dashboardContent.innerHTML = contentHTML;
        },

        // --- ALL MONTHS PDF (Corrected Logic) ---
        generateAllMonthsPdf() {
            const doc = new jsPDF();
            doc.setFont('helvetica');

            // 1. Find all unique months based on the `feeForMonth` field.
            const allMonths = new Set();
            this.collections.forEach(c => allMonths.add(c.feeForMonth.slice(0, 7)));
            
            const sortedMonths = Array.from(allMonths).sort().reverse(); // Show recent months first

            if (sortedMonths.length === 0) {
                return alert('No data available to generate a report.');
            }

            let isFirstPage = true;

            // 2. Loop through each unique month. Each month gets its own page.
            sortedMonths.forEach(monthStr => {
                if (!isFirstPage) {
                    doc.addPage();
                }
                isFirstPage = false;
                
                // 3. Filter all collections to get only the payments *for* this month.
                const salaryDataForThisMonth = this.collections.filter(c => c.feeForMonth.slice(0, 7) === monthStr)
                                                 .sort((a,b) => new Date(a.collectionDate) - new Date(b.collectionDate));
                
                doc.setFontSize(16);
                doc.text(`Monthly Fee Report: ${this.formatMonthEn(monthStr)}`, 14, 20);
                
                if (salaryDataForThisMonth.length > 0) {
                    let totalSalary = salaryDataForThisMonth.reduce((s, i) => s + i.amount, 0);
                    doc.autoTable({
                        startY: 25,
                        head: [['Member Name', 'Amount (Tk)', 'Payment Date']],
                        body: salaryDataForThisMonth.map(item => [item.donorEnglishName, item.amount.toFixed(2), this.formatDateEn(item.collectionDate)]),
                        foot: [['Total', totalSalary.toFixed(2), '']],
                        theme: 'grid'
                    });
                } else {
                    doc.setFontSize(10);
                    doc.text('No salary collections recorded for this month.', 14, 32);
                }
            });

            const pageCount = doc.internal.getNumberOfPages();
            const now = new Date();
            const footerText = `Report generated on: ${now.toLocaleDateString('en-US')} at ${now.toLocaleTimeString('en-US')}`;

            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.setFontSize(8);
                doc.text(footerText, 14, pageHeight - 10);
            }

            doc.save(`masjid_all_months_report_en_${new Date().getTime()}.pdf`);
        },


        // --- BACKUP & RESTORE ---
        backupAllData() { const allData = { members: this.members, collections: this.collections, whatsappContacts: this.whatsappContacts }; const dataStr = JSON.stringify(allData, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `masjid_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); },
        handleRestoreData() { const fileInput = document.getElementById('restoreFileInput'); const file = fileInput.files[0]; if (!file) return alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); const reader = new FileReader(); reader.onload = (e) => { try { const restoredData = JSON.parse(e.target.result); if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§')) { localStorage.setItem(this.KEYS.members, JSON.stringify(restoredData.members || [])); localStorage.setItem(this.KEYS.collections, JSON.stringify(restoredData.collections || [])); localStorage.setItem(this.KEYS.whatsappContacts, JSON.stringify(restoredData.whatsappContacts || [])); alert('‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßá‡¶á‡¶ú‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§'); location.reload(); } } catch (err) { alert('‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶®‡ßá‡¶á‡•§'); } }; reader.readAsText(file); fileInput.value = ''; }
    };
    
    app.init();
});
</script>
</body>
</html>